(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{729:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>E});var s=a(7876),n=a(4232),r=a(7328),i=a.n(r),l=a(8955),o=a(1369);let c=e=>{let{onSubmit:t,isSubmitting:a,maxImages:r=5}=e,[i,l]=(0,n.useState)(""),[c,d]=(0,n.useState)([]),[u,m]=(0,n.useState)([]),h=(0,n.useRef)(null),g=e=>{let t=[...c];t.splice(e,1),d(t);let a=[...u];a.splice(e,1),m(a)},w=async e=>{if(e.preventDefault(),!i.trim()&&0===c.length)return void alert("Please add some content or at least one image to your post.");let a=o.p(32),s=o.p(32);await t({content:i,images:c,id:a,pubkey:s,created_at:Math.floor(Date.now()/1e3),kind:1,tags:JSON.stringify([]),sig:""}),l(""),d([]),m([])};return(0,s.jsx)("div",{className:"card mb-6",children:(0,s.jsxs)("form",{onSubmit:w,children:[(0,s.jsx)("div",{className:"mb-4",children:(0,s.jsx)("textarea",{value:i,onChange:e=>{l(e.target.value)},placeholder:"What's happening?",className:"input min-h-[120px] resize-y"})}),u.length>0&&(0,s.jsx)("div",{className:"mb-4 grid grid-cols-2 md:grid-cols-3 gap-2",children:u.map((e,t)=>(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("img",{src:e.url,alt:"Preview ".concat(t),className:"w-full h-32 object-cover rounded-lg"}),(0,s.jsx)("button",{type:"button",onClick:()=>g(t),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"\xd7"})]},t))}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("input",{ref:h,type:"file",accept:"image/*",multiple:!0,onChange:e=>{let t=Array.from(e.target.files).slice(0,r-c.length);t.length>0&&(d([...c,...t]),t.forEach(e=>{let t=new FileReader;t.onloadend=()=>{m(a=>[...a,{file:e,url:t.result}])},t.readAsDataURL(e)}))},className:"hidden"}),(0,s.jsx)("button",{type:"button",onClick:()=>{h.current.click()},disabled:c.length>=r||a,className:"p-2 rounded-full ".concat(c.length>=r?"bg-gray-300 cursor-not-allowed":"bg-blue-100 text-blue-600 hover:bg-blue-200"),children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"})})}),c.length>0&&(0,s.jsxs)("span",{className:"text-sm text-gray-500 self-center",children:[c.length,"/",r," images"]})]}),(0,s.jsx)("button",{type:"submit",disabled:a||!i.trim()&&0===c.length,className:"btn ".concat(a||!i.trim()&&0===c.length?"bg-blue-300 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600"),children:a?"Publishing...":"Publish"})]})]})})},d=e=>{let{post:t,metadataUrl:a}=e,[r,i]=(0,n.useState)(null),[l,o]=(0,n.useState)(!0),[c,d]=(0,n.useState)(null);return((0,n.useEffect)(()=>{(async()=>{try{if(t.content){i({content:t.content,images:t.images||[]}),o(!1);return}if(a){let e=await fetch(a);if(!e.ok)throw Error("Failed to fetch metadata");let t=await e.json();i(t)}else i({content:t.content||"",images:[]})}catch(e){console.error("Error fetching metadata:",e),d(e.message)}finally{o(!1)}})()},[t,a]),l)?(0,s.jsxs)("div",{className:"card animate-pulse mb-4",children:[(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4 mb-2"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/2 mb-4"}),(0,s.jsx)("div",{className:"h-24 bg-gray-200 rounded mb-4"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/4"})]}):c?(0,s.jsx)("div",{className:"card mb-4 border-red-200 bg-red-50",children:(0,s.jsxs)("p",{className:"text-red-500",children:["Error loading post: ",c]})}):(0,s.jsxs)("div",{className:"card mb-4",children:[(0,s.jsxs)("div",{className:"mb-2 flex justify-between items-start",children:[(0,s.jsx)("h3",{className:"font-medium text-gray-800",children:t.pubkey?t.pubkey.substring(0,8)+"...":"Anonymous"}),(0,s.jsx)("span",{className:"text-xs text-gray-500",children:(e=>e?new Date("string"==typeof e?isNaN(e)?e:1e3*Number(e):1e3*e).toLocaleString():"")(t.createdAt||t.created_at)})]}),(null==r?void 0:r.content)&&(0,s.jsx)("p",{className:"text-gray-700 mb-3 whitespace-pre-wrap",children:r.content}),(null==r?void 0:r.images)&&r.images.length>0&&(0,s.jsx)("div",{className:"mb-3 grid grid-cols-1 gap-2",children:r.images.map((e,t)=>(0,s.jsx)("img",{src:"string"==typeof e?e:e.url,alt:"Post image ".concat(t+1),className:"rounded-lg w-full"},t))}),(0,s.jsxs)("div",{className:"flex text-sm text-gray-500",children:[(0,s.jsxs)("span",{className:"mr-2",children:["TokenID: ",t.tokenId||"N/A"]}),t.kind&&(0,s.jsxs)("span",{className:"mr-2",children:["Kind: ",t.kind]})]})]})};var u=a(6483),m=a(1005),h=a(3366),g=a(695);let w=["event PubEvent(bytes32 id, bytes32 indexed pubkey, uint256 created_at, uint32 indexed kind, string content, string tags, string sig)","function createPost(address toAddress, string memory url, uint256 tokenId, bytes32 id, bytes32 pubkey, uint256 created_at, uint32 kind, string memory content, string memory tags, string memory sig, uint256 quantity) public","function updatePost(uint256 tokenId, string memory newUrl, bytes32 id, bytes32 pubkey, uint256 created_at, uint32 kind, string memory content, string memory tags, string memory sig) public","function uri(uint256 tokenId) public view returns (string memory)","function totalPosts() external view returns (uint256)","function totalSupply(uint256 id) public view returns (uint256)","function setAllowMultiple(uint256 tokenId, bool allow) public"];class p{async connect(e){return this.contract=this.contract.connect(e),this}async createPost(e,t,a,s,n,r,i,l,o,c){let d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1;return this.contract.createPost(e,t,a,s,n,r,i,l,o,c,d)}async updatePost(e,t,a,s,n,r,i,l,o){return this.contract.updatePost(e,t,a,s,n,r,i,l,o)}async totalPosts(){return this.contract.totalPosts()}async getUri(e){return this.contract.uri(e)}async getPostEvents(){let e=this.contract.filters.PubEvent();return(await this.contract.queryFilter(e)).map(e=>{let{id:t,pubkey:a,created_at:s,kind:n,content:r,tags:i,sig:l}=e.args;return{id:t,pubkey:a,createdAt:s.toString(),kind:n.toString(),content:r,tags:i,sig:l,tokenId:e.args[1]}})}constructor(e,t){this.contractAddress=e,this.provider=t,this.contract=new g.NZ(e,w,t)}}var x=a(5364);let b=(0,n.createContext)();function y(e){let{children:t}=e,[a,r]=(0,n.useState)(null),[i,l]=(0,n.useState)(null),[o,c]=(0,n.useState)(null),[d,m]=(0,n.useState)(null),[g,w]=(0,n.useState)(!1),[y,f]=(0,n.useState)(null),[v,N]=(0,n.useState)(null),[j,S]=(0,n.useState)(null);(0,n.useEffect)(()=>{if(window.ethereum)try{let e=new u.j(window.ethereum);l(e)}catch(e){console.error("Error initializing Web3Provider:",e),f("Failed to initialize Web3 provider")}else if(x.env.NEXT_PUBLIC_ALCHEMY_API_KEY)try{let e=new h.R("homestead",x.env.NEXT_PUBLIC_ALCHEMY_API_KEY);l(e)}catch(e){console.error("Error initializing AlchemyProvider:",e),f("Failed to initialize Alchemy provider")}else f("No Web3 provider available")},[]),(0,n.useEffect)(()=>{if(i&&x.env.NEXT_PUBLIC_CONTRACT_ADDRESS)try{let e=new p(x.env.NEXT_PUBLIC_CONTRACT_ADDRESS,i);m(e)}catch(e){console.error("Error initializing contract:",e),f("Failed to initialize contract")}},[i]),(0,n.useEffect)(()=>{(async()=>{if(i)try{let e=await i.getNetwork();N(e.chainId),S(e.name)}catch(e){console.error("Error getting network:",e)}})()},[i]),(0,n.useEffect)(()=>{if(window.ethereum){let e=e=>{if(0===e.length)r(null),c(null);else if(e[0]!==a&&(r(e[0]),i)){let e=new u.j(window.ethereum).getSigner();c(e),d&&d.connect(e)}},t=()=>{window.location.reload()};return window.ethereum.on("accountsChanged",e),window.ethereum.on("chainChanged",t),()=>{window.ethereum.removeListener("accountsChanged",e),window.ethereum.removeListener("chainChanged",t)}}},[a,i,d]);let k=(0,n.useCallback)(async()=>{if(!window.ethereum)return void f("MetaMask is not installed");w(!0),f(null);try{let e=new u.j(window.ethereum),t=await window.ethereum.request({method:"eth_requestAccounts"});r(t[0]),l(e),c(e.getSigner()),d&&await d.connect(e.getSigner())}catch(e){console.error("Error connecting wallet:",e),f(e.message||"Failed to connect wallet")}finally{w(!1)}},[d]),C=(0,n.useCallback)(()=>{r(null),c(null)},[]);return(0,s.jsx)(b.Provider,{value:{account:a,provider:i,signer:o,etchContract:d,chainId:v,networkName:j,isConnecting:g,error:y,connectWallet:k,disconnectWallet:C},children:t})}function f(){let e=(0,n.useContext)(b);if(void 0===e)throw Error("useWallet must be used within a WalletProvider");return e}let v=e=>{let{isOpen:t,onClose:a,onSetupComplete:r}=e,{connectWallet:i,isConnecting:l,error:o}=f(),[c,d]=(0,n.useState)(""),[h,g]=(0,n.useState)(!1),[w,p]=(0,n.useState)(null),[x,b]=(0,n.useState)(null),y=()=>{try{return JSON.parse(c),localStorage.setItem("arweaveJwk",c),!0}catch(e){return alert("Invalid Arweave key format. Please enter valid JSON."),!1}},v=async()=>{if(!window.ethereum)return void p("Please install MetaMask to deploy the contract");g(!0),p(null);try{let e=new u.j(window.ethereum).getSigner(),t=await m.getContractFactory("EtchV1",e),a=await t.deploy();await a.deployed(),localStorage.setItem("CONTRACT_ADDRESS",a.address),b(a.address),window.location.reload()}catch(e){console.error("Error deploying contract:",e),p(e.message||"Failed to deploy contract")}finally{g(!1)}};return t?(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Setup Required"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"font-medium mb-2",children:"1. Connect Wallet"}),(0,s.jsx)("button",{onClick:i,disabled:l,className:"btn w-full",children:l?"Connecting...":"Connect Wallet"}),o&&(0,s.jsx)("p",{className:"text-red-500 text-sm mt-1",children:o})]}),(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"font-medium mb-2",children:"2. Arweave Key"}),(0,s.jsx)("textarea",{value:c,onChange:e=>{d(e.target.value)},placeholder:"Paste your Arweave JWK here",className:"input min-h-[100px]"})]}),(0,s.jsxs)("div",{className:"border-b pb-4",children:[(0,s.jsx)("h3",{className:"font-medium mb-2",children:"3. Deploy Contract"}),(0,s.jsx)("button",{onClick:v,disabled:h,className:"btn w-full bg-green-500 hover:bg-green-600",children:h?"Deploying...":"Deploy Contract"}),w&&(0,s.jsx)("p",{className:"text-red-500 text-sm mt-1",children:w}),x&&(0,s.jsxs)("p",{className:"text-green-500 text-sm mt-1",children:["Contract deployed at: ",x]})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,s.jsx)("button",{onClick:a,className:"px-4 py-2 text-gray-600 hover:text-gray-800",children:"Cancel"}),(0,s.jsx)("button",{onClick:()=>{y()&&r()},className:"btn",children:"Complete Setup"})]})]})]})}):null};var N=a(2525),j=a.n(N);class S{async uploadImage(e){try{let t=await e.arrayBuffer(),a=await this.arweave.createTransaction({data:t},this.jwk);a.addTag("Content-Type",e.type),await this.arweave.transactions.sign(a,this.jwk);let s=await this.arweave.transactions.post(a);if(200===s.status||202===s.status)return{id:a.id,url:"https://arweave.net/".concat(a.id),status:"success"};throw Error("Transaction failed with status ".concat(s.status))}catch(e){throw console.error("Arweave upload error:",e),e}}async uploadImages(e){return e&&0!==e.length?Promise.all(e.map(e=>this.uploadImage(e))):[]}async uploadMetadata(e,t){let a={content:e,images:t,timestamp:Date.now(),version:"1.0"};try{let e=await this.arweave.createTransaction({data:JSON.stringify(a)},this.jwk);e.addTag("Content-Type","application/json"),e.addTag("App-Name","EtchLocal"),e.addTag("Type","post-metadata"),await this.arweave.transactions.sign(e,this.jwk);let t=await this.arweave.transactions.post(e);if(200===t.status||202===t.status)return{id:e.id,url:"https://arweave.net/".concat(e.id),status:"success"};throw Error("Metadata transaction failed with status ".concat(t.status))}catch(e){throw console.error("Arweave metadata upload error:",e),e}}constructor(e){this.arweave=j().init({host:"arweave.net",port:443,protocol:"https"}),this.jwk="string"==typeof e?JSON.parse(e):e}}var k=a(5364);function C(){let{account:e,connectWallet:t,isConnecting:a,error:r,etchContract:o}=f(),[u,m]=(0,n.useState)([]),[h,g]=(0,n.useState)(!1),[w,p]=(0,n.useState)(null),[x,b]=(0,n.useState)(!0),[y,N]=(0,n.useState)(null),[j,C]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let t=k.env.NEXT_PUBLIC_CONTRACT_ADDRESS||localStorage.getItem("CONTRACT_ADDRESS"),a=localStorage.getItem("arweaveJwk");e&&t&&a||C(!0)},[e]),(0,n.useEffect)(()=>{{let e=localStorage.getItem("arweaveJwk");if(e)try{let t=JSON.parse(e);N(new S(t))}catch(e){console.error("Error initializing Arweave storage:",e),p("Failed to initialize Arweave storage")}}},[]);let E=(0,n.useCallback)(async()=>{if(o){b(!0),p(null);try{let e=await o.getPostEvents();m(e.reverse())}catch(e){console.error("Error loading posts:",e),p("Failed to load posts")}finally{b(!1)}}},[o]);(0,n.useEffect)(()=>{o&&E()},[o,E]);let P=async t=>{if(!e||!o||!y)return void p("Please connect your wallet and ensure Arweave is configured");g(!0),p(null);try{let a=(await y.uploadImages(t.images)).map(e=>e.url),s=await y.uploadMetadata(t.content,a),n=Math.floor(Date.now()/1e3)+Math.floor(1e3*Math.random()),r=t.id,i=t.pubkey;"string"==typeof r&&(r=l.R(r)),"string"==typeof i&&(i=l.R(i));let c=await o.createPost(e,s.url,n,r,i,t.created_at,t.kind,t.content,t.tags,t.sig||"",1);await c.wait(),await E()}catch(e){console.error("Error submitting post:",e),p(e.message||"Failed to submit post")}finally{g(!1)}};return(0,s.jsxs)("div",{className:"min-h-screen py-4",children:[(0,s.jsxs)(i(),{children:[(0,s.jsx)("title",{children:"Etch Social - Local Posts"}),(0,s.jsx)("meta",{name:"description",content:"Create and view NFT posts locally"}),(0,s.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,s.jsxs)("main",{className:"container mx-auto px-4 max-w-md",children:[(0,s.jsxs)("header",{className:"mb-6 text-center",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-blue-600 mb-2",children:"Etch Social"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Create and publish posts as NFTs"}),e?(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:["Connected: ",e.substring(0,6),"...",e.substring(e.length-4)]}):(0,s.jsx)("button",{onClick:()=>C(!0),disabled:a,className:"btn",children:a?"Connecting...":"Setup Required"})]}),(r||w)&&(0,s.jsx)("div",{className:"mb-4 p-3 bg-red-100 border border-red-300 text-red-600 rounded",children:r||w}),e&&y&&(0,s.jsx)(c,{onSubmit:P,isSubmitting:h}),(0,s.jsx)("h2",{className:"text-xl font-medium mb-4 text-gray-800",children:"Recent Posts"}),x?(0,s.jsx)("div",{className:"text-center text-gray-500",children:"Loading posts..."}):0===u.length?(0,s.jsx)("div",{className:"text-center text-gray-500",children:"No posts found. Create the first one!"}):(0,s.jsx)("div",{className:"space-y-4",children:u.map((e,t)=>(0,s.jsx)(d,{post:e,metadataUrl:e.tokenUri},"".concat(e.id,"-").concat(t)))})]}),(0,s.jsx)(v,{isOpen:j,onClose:()=>C(!1),onSetupComplete:()=>{C(!1),window.location.reload()}})]})}function E(){return(0,s.jsx)(y,{children:(0,s.jsx)(C,{})})}},2936:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(729)}])},7790:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[131,636,593,792],()=>t(2936)),_N_E=e.O()}]);